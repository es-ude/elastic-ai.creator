name: Checks
on:
  pull_request:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-code-lint:
    name: Lint Source Code
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo shallowly
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: prepare devenv
        uses: ./.github/actions/prepare-devenv
      - name: run python linting
        run: devenv --option torch.backend:string "cpu" tasks run check:code-lint --mode before

  check-commit-lint:
    name: Lint Commits
    runs-on: ubuntu-latest
    steps:
      - name: "get PR commits + 1"
        run: echo "PR_FETCH_DEPTH=$(( ${{ github.event.pull_request.commits }} + 1 ))" >> "${GITHUB_ENV}"
      - name: "Checkout PR branch and all PR commits"
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: ${{ github.env.PR_FETCH_DEPTH }}
      - name: prepare devenv
        uses: ./.github/actions/prepare-devenv
      - name: run commit linting
        run: devenv --option torch.backend:string "cpu" tasks run check:commit-lint --mode before

  check-package-build:
    name: Check that package builds
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo shallowly
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: prepare devenv
        uses: ./.github/actions/prepare-devenv

      - name: run build check
        shell: devenv --option torch.backend:string "cpu" shell bash -- -e {0}
        run: devenv tasks run package:build --mode before

  check-docs-build:
    name: check that docs build
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: checkout repo shallowly
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: prepare devenv
        uses: ./.github/actions/prepare-devenv
      - name: run docs build check
        run: |
          devenv --option torch.backend:string "cpu" tasks run docs:single-page --mode before
          nix run nixpkgs#monolith -- build/docs/index.html > build/docs/single_page.html
      - name: compress docs preview
        run: gzip -9 -c build/docs/single_page.html > build/docs/single_page.html.gz
      - name: Upload docs preview
        uses: actions/upload-artifact@v4
        id: artifact-upload
        with:
          name: docs-preview
          path: build/docs/single_page.html.gz
          retention-days: 1
      - name: Comment on PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: docs-preview
          message: |
            ðŸ“š Documentation preview has been built and attached as an artifact.

            [Download Documentation Preview](${{ steps.artifact-upload.outputs.artifact-url }})

            You can also find it in the "Artifacts" section of this workflow run.

  check-tests:
    name: Run all tests
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo shallowly
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: prepare devenv
        uses: ./.github/actions/prepare-devenv
      - name: run tests
        run: devenv --option torch.backend:string "cpu" tasks run check:tests --mode before
      - name: Publish coverage report
        uses: orgoro/coverage@v3.1
        with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
